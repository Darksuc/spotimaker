<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spotimaker</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
            max-width: 820px;
            margin: 40px auto;
            padding: 0 16px;
        }

        textarea {
            width: 100%;
            min-height: 110px;
            padding: 12px;
            font-size: 16px;
        }

        button {

            padding: 10px 14px;
            font-size: 16px;
            cursor: pointer;
        }

        .hint {
            opacity: .7;
            margin-top: 8px;
        }

        .loading {
            margin-top: 12px;
            font-weight: 600;
        }

        pre {
            white-space: pre-wrap;
            background: #f6f6f6;
            padding: 12px;
            border-radius: 10px;
        }

        .card {
            margin-top: 16px;
            padding: 14px;
            border: 1px solid #eee;
            border-radius: 12px;
        }

        ol {
            margin: 8px 0 0 18px;
        }
    </style>
</head>
<body>
    <h1>Spotimaker</h1>
    <p><b>Ruh halini yaz. Playlist’in hazır.</b></p>

<textarea id="text" placeholder="Kendin gibi yaz. Mood + mekan + his yeter. Ornek: gece surusu, sakin ama kendinden emin."></textarea>
    <div class="hint">Ruh halini söyle, müziği bize bırak.</div>
    <div style="margin-top: 12px;">
        <button id="btn">Playlist oluştur</button>
        <div style="margin-top:10px;">
            <label for="count" style="font-size:14px; opacity:0.8;">
                Sarki sayisi: <b><span id="countVal">20</span></b>
            </label>
            <input id="count" type="range" min="20" max="200" step="10" value="20" style="width:100%; max-width:520px; display:block; margin-top:6px;">
            <div style="font-size:12px; opacity:0.6; margin-top:4px;">
                Free: gunluk 50 sarki Spotify'a kaydetme hakki (yakinda).
            </div>
        </div>

        <a id="spotifyLink" href="/login" style="margin-left:10px; text-decoration:none; padding:10px 14px; border:1px solid #ddd; border-radius:10px; display:inline-block;">
            Spotify bagla
        </a>
        <span id="spotifyStatus" style="margin-left:10px; font-size:14px; opacity:0.75;"></span>

    </div>

    <div id="loadingWrap" style="display:none; margin-top:12px;">
        <div style="font-weight:600; margin-bottom:6px;">
            Playlist hazırlanıyor<span id="dots"></span>
        </div>
        <div style="width:100%; max-width:520px; height:10px; border:1px solid #ddd; border-radius:999px; overflow:hidden;">
            <div id="loadingBar" style="height:100%; width:0%; border-radius:999px; background:#111;"></div>
        </div>
        <div style="font-size:12px; opacity:0.65; margin-top:6px;">Birkaç dakika sürebilir</div>
    </div>

    <div id="out"></div>

    <script>
        const btn = document.getElementById("btn");
        const text = document.getElementById("text");
        const out = document.getElementById("out");
        const loadingWrap = document.getElementById("loadingWrap");
        const loadingBar = document.getElementById("loadingBar");
        const spotifyStatus = document.getElementById("spotifyStatus");
        const spotifyLink = document.getElementById("spotifyLink");
        const count = document.getElementById("count");
        const countVal = document.getElementById("countVal");
        const dots = document.getElementById("dots");
        let dotsTimer = null;
        let slowTimer = null;

        function startSlowHint() {
            slowTimer = setTimeout(() => {
                const el = document.querySelector(
                    "#loadingWrap div:nth-child(3)"
                );
                if (el) el.textContent = "Biraz uzun sürüyor ama değecek.";
            }, 6000);
        }

        function stopSlowHint() {
            if (slowTimer) clearTimeout(slowTimer);
            slowTimer = null;
        }

        function startDots() {
            if (!dots) return;
            let i = 0;
            dots.textContent = "";
            clearInterval(dotsTimer);
            dotsTimer = setInterval(() => {
                i = (i + 1) % 4;
                dots.textContent = ".".repeat(i);
            }, 350);
        }

        function stopDots() {
            if (!dots) return;
            clearInterval(dotsTimer);
            dotsTimer = null;
            dots.textContent = "";
        }


        count.oninput = () => {
            countVal.textContent = count.value;
        };



        async function checkSpotify() {
            try {
                const r = await fetch("/debug/spotify");
                const j = await r.json();

                if (j.ok) {
                    spotifyStatus.textContent = `Spotify baglandi: ${j.me.display_name}`;
                    spotifyLink.textContent = "Spotify bagli";
                    spotifyLink.href = "#";
                    spotifyLink.style.pointerEvents = "none";
                    spotifyLink.style.opacity = "0.6";
                } else {
                    spotifyStatus.textContent = "Spotify bagli degil";
                    spotifyLink.textContent = "Spotify bagla";
                    spotifyLink.href = "/login";
                    spotifyLink.style.pointerEvents = "auto";
                    spotifyLink.style.opacity = "1";
                }
            } catch (e) {
                spotifyStatus.textContent = "";
            }
        }

        checkSpotify();

        let loadingTimer = null;

        function showLoadingBar() {
            startDots();
            startSlowHint();
            startDots();

            loadingWrap.style.display = "block";
            loadingBar.style.width = "0%";

            let p = 0;
            clearInterval(loadingTimer);

            loadingTimer = setInterval(() => {
                const step = p < 70 ? 3 : p < 90 ? 1 : 0.2;
                p = Math.min(p + step, 95);
                loadingBar.style.width = `${p}%`;
            }, 120);
        }

        function hideLoadingBar() {
            stopDots();
            stopSlowHint();

            stopDots();

            clearInterval(loadingTimer);
            loadingBar.style.width = "100%";

            setTimeout(() => {
                loadingWrap.style.display = "none";
                loadingBar.style.width = "0%";
            }, 250);
        }


        function escapeHtml(s) {
            return s.replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c]));
        }

        btn.onclick = async () => {
            out.innerHTML = "";
            showLoadingBar();

            btn.disabled = true;

            try {
                const resp = await fetch("/api/generate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: text.value, count: Number(count.value) })
                });

                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || "Request failed");

                const tracks = data.tracks.map(t => `<li>${escapeHtml(t.artist)} - ${escapeHtml(t.song)}</li>`).join("");


                out.innerHTML = `

                                <div class="card">
                                <div><b>Bu liste sana göre hazırlandı.</b></div>

                                  <h2 style="margin: 10px 0 6px 0;">${escapeHtml(data.title)}</h2>
                                  <div style="opacity:.85">${escapeHtml(data.description)}</div>
                                  <div style="margin-top:10px; opacity:.75">Tags: ${escapeHtml(data.vibe_tags.join(", "))}</div>
                                  <div style="margin-top:10px;">
                                  <div style="margin-top:12px;">
      <button id="saveSpotifyBtn">Spotify'a ekle</button>
      <span id="saveSpotifyMsg" style="margin-left:10px; opacity:0.75;"></span>
</div>

                                    <b>Tracklist</b>
                                    <ol>${tracks}</ol>
                                  </div>
                                  <details style="margin-top:10px;">
                                    <summary>Show JSON</summary>
                                    <pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                                  </details>
                                </div>
                              `;
                const saveBtn = document.getElementById("saveSpotifyBtn");
                const saveMsg = document.getElementById("saveSpotifyMsg");

                saveBtn.onclick = async () => {
                    saveBtn.disabled = true;
                    saveMsg.textContent = "Spotify'a ekleniyor...";

                    try {
                        const r = await fetch("/spotify/save", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                title: data.title,
                                description: data.description,
                                tracks: data.tracks
                            })
                        });

                        const j = await r.json();
                        if (!r.ok) throw new Error(j.error || "Save failed");

                        saveMsg.innerHTML = j.playlist?.url
                            ? `Eklendi: <a href="${j.playlist.url}" target="_blank">Spotify'da ac</a> (${j.added}/${j.requested})`
                            : `Eklendi (${j.added}/${j.requested})`;
                    } catch (e) {
                        saveMsg.textContent = String(e);
                    } finally {
                        saveBtn.disabled = false;
                    }
                };

            } catch (e) {
                out.innerHTML = `<pre>${escapeHtml(String(e))}</pre>`;
            } finally {
                hideLoadingBar();

                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
