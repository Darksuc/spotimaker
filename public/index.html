<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spotimaker</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
            max-width: 820px;
            margin: 40px auto;
            padding: 0 16px;
        }

        textarea {
            width: 100%;
            min-height: 110px;
            padding: 12px;
            font-size: 16px;
        }

        button {
            padding: 10px 14px;
            font-size: 16px;
            cursor: pointer;
        }

        .hint {
            opacity: .7;
            margin-top: 8px;
        }

        .loading {
            margin-top: 12px;
            font-weight: 600;
        }

        pre {
            white-space: pre-wrap;
            background: #f6f6f6;
            padding: 12px;
            border-radius: 10px;
        }

        .card {
            margin-top: 16px;
            padding: 14px;
            border: 1px solid #eee;
            border-radius: 12px;
        }

        ol {
            margin: 8px 0 0 18px;
        }
    </style>
    :root{
    --bg:#0b0b0f;
    --card:#12121a;
    --muted:rgba(255,255,255,.72);
    --text:#fff;
    --line:rgba(255,255,255,.12);
    --accent:#22c55e;
    --accent2:#3b82f6;
    }

    body{
    background:
    radial-gradient(1200px 600px at 20% 0%, rgba(34,197,94,.18), transparent 60%),
    radial-gradient(1000px 700px at 80% 10%, rgba(59,130,246,.14), transparent 60%),
    var(--bg);
    color:var(--text);
    }

    .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    padding:14px;
    border:1px solid var(--line);
    border-radius:18px;
    background: rgba(18,18,26,.75);
    backdrop-filter: blur(10px);
    }

    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
    width:44px; height:44px;
    border-radius:14px;
    display:flex; align-items:center; justify-content:center;
    border:1px solid var(--line);
    background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(59,130,246,.14));
    }

    .brand-name{font-weight:900; letter-spacing:.2px; font-size:18px;}
    .brand-sub{font-size:13px; color:var(--muted);}

    .nav{display:flex; align-items:center; gap:10px;}
    .navlink{
    color:var(--muted);
    text-decoration:none;
    padding:10px 10px;
    border-radius:12px;
    }
    .navlink:hover{background: rgba(255,255,255,.05); color:#fff;}

    .navbtn{
    color:#0b0b0f;
    background: #fff;
    text-decoration:none;
    padding:10px 12px;
    border-radius:12px;
    font-weight:900;
    }
    .navbtn:hover{opacity:.92;}

    .hero{margin-top:18px; margin-bottom:14px;}
    .h1{margin:0 0 6px 0; font-size:26px; letter-spacing:-.3px;}
    .p{margin:0; color:var(--muted); line-height:1.5;}

    textarea{
    border-radius:16px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    color:#fff;
    outline:none;
    }

    button{
    border-radius:14px;
    border:1px solid var(--line);
    background:#fff;
    color:#0b0b0f;
    font-weight:900;
    }
    button:disabled{opacity:.6; cursor:not-allowed;}

    .card{
    background: rgba(18,18,26,.75);
    border:1px solid var(--line);
    border-radius:16px;
    }

    pre{
    background: rgba(255,255,255,.04);
    border:1px solid var(--line);
    }
    .hint{color:var(--muted);}

</head>
<body>
    <header class="topbar">
        <div class="brand">
            <div class="logo" aria-hidden="true">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                    <path d="M12 3c4.9 0 9 4 9 9s-4.1 9-9 9-9-4-9-9 4.1-9 9-9z" stroke="currentColor" stroke-width="2" />
                    <path d="M9 8c3 0 6 1 6 3s-3 3-6 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M9 14c3 0 6 1 6 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </div>
            <div>
                <div class="brand-name">Spotimaker</div>
                <div class="brand-sub">Ruh haline gore playlist.</div>
                <div id="spotifyStatus" class="brand-sub" style="margin-top:4px;"></div>
            </div>
        </div>

        <nav class="nav">
            <a href="/premium.html" class="navlink">Premium</a>
            <a id="spotifyLink" href="/login" class="navbtn">Spotify bagla</a>
        </nav>
    </header>
    <div class="hero">
        <h1 class="h1">Ruh halini yaz, playlistin hazir.</h1>
        <p class="p">Mood + ortam + his yeter. Spotify hesabina kaydetmek istersen tek tik.</p>
    </div>
sgt
<textarea id="text" placeholder="Kendin gibi yaz. Mood + mekan + his yeter. Ornek: gece surusu, sakin ama kendinden emin."></textarea>
    <div class="hint">Ruh halini söyle, müziği bize bırak.</div>
    <div style="margin-top: 12px;">
        <button id="btn">Playlist oluştur</button>
        <div style="margin-top:10px;">
            <label for="count" style="font-size:14px; opacity:0.8;">
                Sarki sayisi: <b><span id="countVal">20</span></b>
            </label>
            <input id="count" type="range" min="20" max="200" step="10" value="20" style="width:100%; max-width:520px; display:block; margin-top:6px;">
            <div style="font-size:12px; opacity:0.6; margin-top:4px;">
                Free: gunluk 50 sarki Spotify'a kaydetme hakki (yakinda).
            </div>
        </div>

        <a id="spotifyLink" href="/login" style="margin-left:10px; text-decoration:none; padding:10px 14px; border:1px solid #ddd; border-radius:10px; display:inline-block;">
            Spotify bagla
        </a>
        <span id="spotifyStatus" style="margin-left:10px; font-size:14px; opacity:0.75;"></span>

    </div>

    <div id="loadingWrap" style="display:none; margin-top:12px;">
        <div style="font-weight:600; margin-bottom:6px;">
            Playlist hazırlanıyor<span id="dots"></span>
        </div>
        <div style="width:100%; max-width:520px; height:10px; border:1px solid #ddd; border-radius:999px; overflow:hidden;">
            <div id="loadingBar" style="height:100%; width:0%; border-radius:999px; background:#111;"></div>
        </div>
        <div style="font-size:12px; opacity:0.65; margin-top:6px;">Birkaç dakika sürebilir</div>
    </div>

    <div id="out"></div>

    <script>
        const btn = document.getElementById("btn");
        const text = document.getElementById("text");
        const out = document.getElementById("out");
        const loadingWrap = document.getElementById("loadingWrap");
        const loadingBar = document.getElementById("loadingBar");
        const spotifyStatus = document.getElementById("spotifyStatus");
        const spotifyLink = document.getElementById("spotifyLink");
        const count = document.getElementById("count");
        const countVal = document.getElementById("countVal");
        const dots = document.getElementById("dots");
        let dotsTimer = null;
        let slowTimer = null;

        function startSlowHint() {
            slowTimer = setTimeout(() => {
                const el = document.querySelector(
                    "#loadingWrap div:nth-child(3)"
                );
                if (el) el.textContent = "Biraz uzun sürüyor ama değecek.";
            }, 6000);
        }

        function stopSlowHint() {
            if (slowTimer) clearTimeout(slowTimer);
            slowTimer = null;
        }

        function startDots() {
            if (!dots) return;
            let i = 0;
            dots.textContent = "";
            clearInterval(dotsTimer);
            dotsTimer = setInterval(() => {
                i = (i + 1) % 4;
                dots.textContent = ".".repeat(i);
            }, 350);
        }

        function stopDots() {
            if (!dots) return;
            clearInterval(dotsTimer);
            dotsTimer = null;
            dots.textContent = "";
        }


        count.oninput = () => {
            countVal.textContent = count.value;
        };



        async function checkSpotify() {
            try {
                const r = await fetch("/debug/spotify");
                const j = await r.json();

                if (j.ok) {
                    spotifyStatus.textContent = `Spotify baglandi: ${j.me.display_name}`;
                    spotifyLink.textContent = "Spotify bagli";
                    spotifyLink.href = "#";
                    spotifyLink.style.pointerEvents = "none";
                    spotifyLink.style.opacity = "0.6";
                } else {
                    spotifyStatus.textContent = "Spotify bagli degil";
                    spotifyLink.textContent = "Spotify bagla";
                    spotifyLink.href = "/login";
                    spotifyLink.style.pointerEvents = "auto";
                    spotifyLink.style.opacity = "1";
                }
            } catch (e) {
                spotifyStatus.textContent = "";
            }
        }

        checkSpotify();

        let loadingTimer = null;

        function showLoadingBar() {
            startDots();
            startSlowHint();
            startDots();

            loadingWrap.style.display = "block";
            loadingBar.style.width = "0%";

            let p = 0;
            clearInterval(loadingTimer);

            loadingTimer = setInterval(() => {
                const step = p < 70 ? 3 : p < 90 ? 1 : 0.2;
                p = Math.min(p + step, 95);
                loadingBar.style.width = `${p}%`;
            }, 120);
        }

        function hideLoadingBar() {
            stopDots();
            stopSlowHint();

            stopDots();

            clearInterval(loadingTimer);
            loadingBar.style.width = "100%";

            setTimeout(() => {
                loadingWrap.style.display = "none";
                loadingBar.style.width = "0%";
            }, 250);
        }


        function escapeHtml(s) {
            return s.replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c]));
        }

        btn.onclick = async () => {
            out.innerHTML = "";
            showLoadingBar();

            btn.disabled = true;

            try {
                const resp = await fetch("/api/generate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: text.value, count: Number(count.value) })
                });

                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || "Request failed");

                const tracks = data.tracks.map(t => `<li>${escapeHtml(t.artist)} - ${escapeHtml(t.song)}</li>`).join("");


                out.innerHTML = `

                                        <div class="card">
                                        <div><b>Bu liste sana göre hazırlandı.</b></div>

                                          <h2 style="margin: 10px 0 6px 0;">${escapeHtml(data.title)}</h2>
                                          <div style="opacity:.85">${escapeHtml(data.description)}</div>
                                          <div style="margin-top:10px; opacity:.75">Tags: ${escapeHtml(data.vibe_tags.join(", "))}</div>
                                          <div style="margin-top:10px;">
                                          <div style="margin-top:12px;">
              <button id="saveSpotifyBtn">Spotify'a ekle</button>
              <span id="saveSpotifyMsg" style="margin-left:10px; opacity:0.75;"></span>
</div>

                                            <b>Tracklist</b>
                                            <ol>${tracks}</ol>
                                          </div>
                                          <details style="margin-top:10px;">
                                            <summary>Show JSON</summary>
                                            <pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                                          </details>
                                        </div>
                                      `;
                const saveBtn = document.getElementById("saveSpotifyBtn");
                const saveMsg = document.getElementById("saveSpotifyMsg");

                saveBtn.onclick = async () => {
                    saveBtn.disabled = true;
                    saveMsg.textContent = "Spotify'a ekleniyor...";

                    try {
                        const r = await fetch("/spotify/save", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                title: data.title,
                                description: data.description,
                                tracks: data.tracks
                            })
                        });

                        const j = await r.json();
                        if (!r.ok) throw new Error(j.error || "Save failed");

                        saveMsg.innerHTML = j.playlist?.url
                            ? `Eklendi: <a href="${j.playlist.url}" target="_blank">Spotify'da ac</a> (${j.added}/${j.requested})`
                            : `Eklendi (${j.added}/${j.requested})`;
                    } catch (e) {
                        saveMsg.textContent = String(e);
                    } finally {
                        saveBtn.disabled = false;
                    }
                };

            } catch (e) {
                out.innerHTML = `<pre>${escapeHtml(String(e))}</pre>`;
            } finally {
                hideLoadingBar();

                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
